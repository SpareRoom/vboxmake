#version=RHEL7

# Text mode
text

# Use CDROM installation media
cdrom

# System authorization information
auth --enableshadow --passalgo=sha512

# Run the Setup Agent on first boot
firstboot --enable
ignoredisk --only-use=sda

# System bootloader configuration
bootloader --location='mbr' --boot-drive='sda'

# Partition clearing information
clearpart --all --initlabel 
autopart --type=lvm

# Keyboard layouts
keyboard --vckeymap=uk --xlayouts=gb

# System language
lang en_GB.UTF-8

# System timezone
timezone Europe/London --isUtc

# Network configuration
network --bootproto=dhcp --ipv6=auto --activate --onboot=yes --hostname=localhost.localdomain

# SELinux
selinux --permissive

# Root password
rootpw --plaintext vagrant

# Vagrant user
user --groups=wheel --homedir=/home/vagrant --name=vagrant --password=vagrant

reboot --eject

%packages --ignoremissing
@core
@base
@development
@performance
deltarpm
kernel-devel
%end

%post

exec < /dev/tty3 > /dev/tty3
chvt 3
(
set -x

mount -t iso9660 -o ro /dev/sr1 /mnt
/mnt/vboxguest/VBoxLinuxGuestAdditions.run
umount /mnt

# https://github.com/mitchellh/vagrant/tree/master/keys
mkdir -p /home/vagrant/.ssh
cat <<'EOF' > /home/vagrant/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA6NF8iallvQVp22WDkTkyrtvp9eWW6A8YVr+kz4TjGYe7gHzIw+niNltGEFHzD8+v1I2YJ6oXevct1YeS0o9HZyN1Q9qgCgzUFtdOKLv6IedplqoPkcmF0aYet2PkEDo3MlTBckFXPITAMzF8dJSIFo9D8HfdOV0IAdx4O7PtixWKn5y2hMNG0zQPyUecp4pzC6kivAIhyfHilFR61RGL+GPXQ2MWZWFYbAGjyiYJnAmCP3NOTd0jMZEnDkbUvxhMmBYSdETk1rRgm+R4LOzFUGaHqHDLKLX+FIPKcF96hrucXzcWyLbIbEgE98OHlnVYCzRdK8jlqm8tehUc9c9WhQ== vagrant insecure public key
EOF

chown -R vagrant:vagrant /home/vagrant/.ssh
chmod 0700 /home/vagrant/.ssh
chmod 0640 /home/vagrant/.ssh/authorized_keys

cat <<'EOF' > /etc/sudoers.d/vagrant
vagrant ALL=(ALL) NOPASSWD: ALL
EOF

shutdown -hP now

set +x
) 2>&1 | /usr/bin/tee /root/ks-post.log

%end
